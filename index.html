<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Blockchain demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
  </head>
  <body>
    <button id="connectButton" onclick="connect()"> Connect </button>
    <h2>Account: <span class="showAccount"></span></h2>

  </body>
  <footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.5/dist/umd/popper.min.js" integrity="sha384-Xe+8cL9oJa6tN/veChSP7q+mnSPaj5Bcu9mPX5F5xIGE0DVittaqT5lorf0EI7Vk" crossorigin="anonymous"></script>
   
    <script type="text/javascript" src="https://unpkg.com/web3@1.7.3/dist/web3.min.js"></script>
    <script src="https://unpkg.com/@metamask/detect-provider/dist/detect-provider.min.js"> </script>
    <!-- https://unpkg.com/web3@1.7.3/dist/web3.min.js -->
   
  </footer>
</html>

<script type="module">

    const ABI = [
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "id",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "receivedBluePrintHashed",
				"type": "string"
			}
		],
		"name": "uploadHashValue",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"name": "blueprintRegistry",
		"outputs": [
			{
				"internalType": "bytes32",
				"name": "",
				"type": "bytes32"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "blueprintName",
				"type": "string"
			}
		],
		"name": "existsHashValue",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "receivedBluePrint",
				"type": "string"
			}
		],
		"name": "hasIntegrity",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]



    let provider = await detectEthereumProvider();
    let web3 = null;

    if(provider) {
        web3 = new Web3(provider);
        console.log("We have a provider");
    } else {
        web3 = new Web3("http://127.0.0.1:7545");
    }

    if(web3 == null){
        throw new Error("Not connected...");
    } else {
        console.log(web3);
    }
    const CONTRACT_ADDRESS = "0x045660a9AE96286f97035569393A2dcbDC6EcD78";

   

    async function hasIntegrity(){
        const contract = new web3.eth.Contract(ABI, CONTRACT_ADDRESS);
        let result = await contract.methods.hasIntegrity("ce").call();
        console.log("has integrity: " + result);
    }

    async function uploadHashValue(){
        getAccount();
        const contract = new web3.eth.Contract(ABI, CONTRACT_ADDRESS, {from: account });
        let result = await contract.methods.uploadHashValue("Marian", "Marian").send();
        console.log("has integrity: " + result);
    }

    async function connect(){ 
        if(typeof window.ethereum !== 'undefined'){
            ethereum.request({method: "eth_requestAccounts"})
        } 
    }

    async function getAccount(){
        const accounts = await web3.eth.requestAccounts();
        const account = accounts[0];
        console.log(account);
    }

    //getAccount();
    //console.log("Ethereum address: " + window.ethereum.selectedAddress);
    getAccount();
</script>
